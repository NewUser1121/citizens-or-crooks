<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create/Edit Bot - Kaleb's Citizens or Crooks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #1e3c72;
      font-family: 'Arial', sans-serif;
      color: #d4d4d4;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      padding: 40px;
      max-width: 1000px;
      width: 100%;
    }
    .input-section {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 25px;
      justify-content: center;
    }
    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 25px;
      justify-content: center;
    }
    .btn {
      border-radius: 20px;
      padding: 10px 20px;
      background-color: #2a5298;
      border: none;
      color: #d4d4d4;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .btn:hover {
      background-color: #3a6bb8;
      transform: translateY(-2px);
    }
    .btn:disabled {
      background-color: #444;
      cursor: not-allowed;
    }
    .username-input, select, input[type="text"] {
      padding: 10px;
      font-size: 1.1em;
      border: none;
      min-width: 180px;
      text-align: center;
      background-color: #add8e6; /* Light blue */
      color: #ffffff; /* White text */
      border-radius: 10px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    .username-input:not([disabled]), select:not([disabled]), input[type="text"]:not([disabled]) {
      border: 2px solid #3a6bb8;
      background-color: #add8e6; /* Light blue */
    }
    .code-editor {
      border: 1px solid #3a6bb8;
      border-radius: 10px;
      padding: 20px;
      height: 500px;
      display: flex;
      background: #1e3c72;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      position: relative;
      margin-bottom: 20px;
    }
    .line-numbers {
      width: 50px;
      text-align: right;
      padding-right: 15px;
      color: #888;
      background: #1e3c72;
      border-right: 1px solid #3a6bb8;
      font-family: 'Consolas', monospace;
    }
    .code-area {
      flex-grow: 1;
      border: none;
      resize: none;
      outline: none;
      background: #1e3c72; /* Dark blue */
      color: #add8e6; /* Light blue text */
      font-family: 'Consolas', monospace;
      line-height: 1.6;
      font-size: 1em;
      padding: 10px;
    }
    .code-area::selection {
      background: #3a6bb8;
      color: #fff;
    }
    .console {
      border: 1px solid #3a6bb8;
      border-radius: 10px;
      padding: 15px;
      background: #1e3c72;
      color: #d4d4d4;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    .console-header {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: #fff;
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 1000;
      animation: fadeInOut 3s ease;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    @media (max-width: 768px) {
      .button-row { flex-direction: column; align-items: center; }
      .input-section { flex-direction: column; align-items: center; }
      .code-editor { height: 350px; }
      .btn, .username-input, select, input[type="text"] { font-size: 0.95rem; }
      .notification { top: 10px; right: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="input-section">
      <input type="text" class="username-input" id="username" placeholder="Enter Username" disabled>
      <select id="bot-select" class="form-control" onchange="loadBot()" disabled>
        <option value="">Choose a bot...</option>
      </select>
      <input type="text" id="bot-name" class="username-input" placeholder="Enter Bot Name" disabled>
    </div>
    <div class="button-row">
      <button class="btn" id="save-btn" onclick="saveBot()">Save</button>
      <button class="btn" id="edit-btn" onclick="toggleEditMode()">Edit</button>
      <button class="btn" onclick="openBot()">Open</button>
      <button class="btn" id="test-btn" onclick="testBot()">Test</button>
      <select class="form-control examples-dropdown" onchange="applyExample(this.value)">
        <option value="">Examples ▼</option>
        <option value="steal">Always Steal</option>
        <option value="stay">Always Stay</option>
        <option value="random">Random Choice</option>
        <option value="firstSteal">Steal First, Then Stay</option>
        <option value="stayFirst">Stay First, Then Steal</option>
        <option value="evenSteal">Steal on Even Rounds</option>
        <option value="oddStay">Stay on Odd Rounds</option>
        <option value="stealIfEarly">Steal if Round is 1-5</option>
      </select>
      <button class="btn" onclick="deleteBot()">Delete</button>
      <div class="tooltip">
        <button class="btn" onclick="showCommands()">Commands</button>
        <span class="tooltiptext">View available coding commands</span>
      </div>
      <button class="btn" onclick="showWhatIsThis()">What Is This</button>
    </div>

    <div class="code-editor">
      <div class="line-numbers" id="line-numbers"></div>
      <textarea class="code-area" id="code-area" spellcheck="false" oninput="updateLineNumbers(); validateCode()"></textarea>
    </div>

    <div id="console" class="console" style="display: none;">
      <div class="console-header">Console ▼</div>
      <div id="console-content"></div>
    </div>

    <div id="notification" class="notification"></div>
    <button class="btn mt-3" onclick="window.location.href='/index.html'">Back to Home</button>
  </div>

  <script>
    let editMode = false;
    let currentBotId = null;
    let autoSaveTimeout = null;

    async function fetchBot() {
      const urlParams = new URLSearchParams(window.location.search);
      const botId = urlParams.get('id');
      if (botId) {
        currentBotId = botId;
        try {
          const response = await fetch(`/api/bots/${botId}`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const bot = await response.json();
          if (bot) {
            document.querySelector('#username').value = bot.username || '';
            document.querySelector('#bot-name').value = bot.botname || '';
            document.querySelector('#code-area').value = bot.code || '';
            updateLineNumbers();
            validateCode();
            populateBots(); // Load bot options
            showNotification(`Loaded bot: ${bot.username || 'Unnamed Bot'}`);
          } else {
            showNotification('Bot not found.', 'error');
          }
        } catch (error) {
          console.error('Error fetching bot:', error);
          showNotification('Failed to load bot. Check console.', 'error');
        }
      } else {
        // Auto-enable edit mode for new bots
        toggleEditMode();
      }
    }

    function updateLineNumbers() {
      const codeArea = document.getElementById('code-area');
      const lineNumbers = document.getElementById('line-numbers');
      const lines = codeArea.value.split('\n').length;
      lineNumbers.innerHTML = Array.from({ length: lines }, (_, i) => i + 1).join('<br>');
    }

    function toggleEditMode() {
      editMode = !editMode;
      const usernameInput = document.querySelector('#username');
      const botNameInput = document.querySelector('#bot-name');
      const botSelect = document.querySelector('#bot-select');
      const codeArea = document.querySelector('#code-area');
      const editBtn = document.getElementById('edit-btn');

      usernameInput.disabled = !editMode;
      botNameInput.disabled = !editMode;
      botSelect.disabled = !editMode;
      codeArea.readOnly = !editMode;

      if (editMode) {
        usernameInput.style.border = '2px solid #3a6bb8';
        botNameInput.style.border = '2px solid #3a6bb8';
        botSelect.style.border = '2px solid #3a6bb8';
        codeArea.style.border = '2px solid #3a6bb8';
        usernameInput.focus();
        editBtn.textContent = 'Done';
      } else {
        usernameInput.style.border = 'none';
        botNameInput.style.border = 'none';
        botSelect.style.border = 'none';
        codeArea.style.border = 'none';
        editBtn.textContent = 'Edit';
      }
    }

    async function populateBots() {
      const username = document.getElementById('username').value.trim();
      if (!username) {
        document.getElementById('bot-select').innerHTML = '<option value="">Choose a bot...</option>';
        return;
      }
      try {
        const response = await fetch(`/api/bots?username=${encodeURIComponent(username)}`);
        const bots = await response.json();
        const botSelect = document.getElementById('bot-select');
        botSelect.innerHTML = '<option value="">Choose a bot...</option>';
        bots.forEach(bot => {
          const option = document.createElement('option');
          option.value = bot.id;
          option.textContent = bot.botname || 'Unnamed Bot';
          botSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error fetching bots:', error);
        showNotification('Failed to load bots. Check console.', 'error');
      }
    }

    async function loadBot() {
      const botSelect = document.getElementById('bot-select');
      currentBotId = botSelect.value;
      if (!currentBotId) return;

      try {
        const response = await fetch(`/api/bots/${currentBotId}`);
        const bot = await response.json();
        document.getElementById('username').value = bot.username || '';
        document.getElementById('bot-name').value = bot.botname || '';
        document.getElementById('code-area').value = bot.code || '';
        updateLineNumbers();
        validateCode();
      } catch (error) {
        console.error('Error loading bot:', error);
        showNotification('Failed to load bot. Check console.', 'error');
      }
    }

    async function openBot() {
      const username = prompt('Enter Username:');
      if (username) {
        try {
          const response = await fetch(`/api/bots?username=${encodeURIComponent(username)}`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const bots = await response.json();
          if (bots.length === 0) {
            alert('No bots found for that username.');
          } else if (bots.length === 1) {
            window.location.href = `/create-edit-bot.html?id=${bots[0].id}`;
          } else {
            const choice = prompt(`Multiple bots found for ${username}. Enter the exact Bot Name to choose one:`);
            const selectedBot = bots.find(bot => bot.botname === choice);
            if (selectedBot) {
              window.location.href = `/create-edit-bot.html?id=${selectedBot.id}`;
            } else {
              alert('Invalid choice.');
            }
          }
        } catch (error) {
          console.error('Error fetching bots:', error);
          showNotification('Failed to fetch bots. Check console.', 'error');
        }
      }
    }

    async function saveBot() {
      const username = document.querySelector('#username').value.trim();
      const botName = document.querySelector('#bot-name').value.trim();
      const code = document.querySelector('#code-area').value.trim();

      // Validation
      if (!username || !botName) {
        showNotification('Please enter a valid Username and Bot Name.', 'error');
        return;
      }

      const botData = { username, botName, code };
      console.log('botData to send:', botData); // Debug: Log the payload

      const url = currentBotId ? `/api/bots/${currentBotId}` : '/api/bots';
      const method = currentBotId ? 'PUT' : 'POST';

      try {
        document.getElementById('save-btn').disabled = true;
        showNotification('Saving...', 'info');
        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(botData),
        });
        const result = await response.json();
        if (response.ok) {
          currentBotId = result.id || currentBotId;
          showNotification(`Bot ${currentBotId ? 'updated' : 'created'}! Saved as: ${botName}`, 'success');
          setTimeout(() => window.location.href = '/view-bots.html', 2000);
        } else {
          console.error('Server error:', result);
          showNotification(`Error saving bot: ${result.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        console.error('Fetch error:', error.message, { url, method, botData });
        showNotification(`Failed to save bot: ${error.message}. Check console.', 'error');
      } finally {
        document.getElementById('save-btn').disabled = false;
      }
    }

    async function deleteBot() {
      if (!currentBotId || !confirm('Are you sure you want to delete this bot?')) return;
      try {
        const response = await fetch(`/api/bots/${currentBotId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();
        if (response.ok) {
          showNotification('Bot deleted successfully!', 'success');
          setTimeout(() => window.location.href = '/my-bots.html', 2000);
        } else {
          showNotification(`Error deleting bot: ${result.error}`, 'error');
        }
      } catch (error) {
        console.error('Delete error:', error);
        showNotification('Failed to delete bot. Check console.', 'error');
      }
    }

    function testBot() {
      const userBotCode = document.querySelector('#code-area').value;
      const simulationResult = simulateGame(userBotCode);
      if (simulationResult.error) {
        showConsole(`Error: ${simulationResult.error}`);
      } else {
        showConsole(simulationResult.results.join('\n') + `\n\nUser Total Points: ${simulationResult.userPoints}, Opponent Total Points: ${simulationResult.opponentPoints}`);
      }
    }

    function simulateGame(userBotCode) {
      let userPoints = 0;
      let opponentPoints = 0;
      const userHistory = [];
      const opponentHistory = [];
      const results = [];

      for (let round = 1; round <= 20; round++) {
        const opponentChoice = round % 2 === 1 ? 'steal' : 'stay'; // Simple alternating opponent
        const userResult = interpretBotCode(userBotCode, opponentHistory, round);
        if (userResult.error) return { error: userResult.error };
        const userChoice = userResult.decision;

        userHistory.push(userChoice);
        opponentHistory.push(opponentChoice);

        const [userPts, oppPts] = calculateRoundPoints(userChoice, opponentChoice);
        userPoints += userPts;
        opponentPoints += oppPts;
        results.push(`Round ${round}: User ${userChoice}, Opponent ${opponentChoice} - User: ${userPoints}, Opponent: ${opponentPoints}`);
      }
      return { results, userPoints, opponentPoints };
    }

    function calculateRoundPoints(choice1, choice2) {
      if (choice1 === 'steal' && choice2 === 'stay') return [8, 0];
      if (choice1 === 'stay' && choice2 === 'steal') return [0, 8];
      if (choice1 === 'stay' && choice2 === 'stay') return [4, 4];
      return [0, 0];
    }

    function interpretBotCode(code, opponentHistory, round) {
      const lines = code.split('\n');
      for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine || trimmedLine.startsWith('//')) continue;

        if (['steal', 'stay'].includes(trimmedLine.toLowerCase())) {
          return { decision: trimmedLine.toLowerCase() };
        }

        const ifMatch = trimmedLine.match(/if (.+) then (.+)( else (.+))?/i);
        if (ifMatch) {
          const condition = ifMatch[1].trim();
          const action = ifMatch[2].trim();
          const elseAction = ifMatch[4] ? ifMatch[4].trim() : null;

          try {
            if (evaluateCondition(condition, round, opponentHistory)) {
              return { decision: executeAction(action, opponentHistory, round) };
            } else if (elseAction) {
              return { decision: executeAction(elseAction, opponentHistory, round) };
            }
          } catch (e) {
            return { error: `Error in line: "${line}": ${e.message}` };
          }
        }
      }
      return { decision: Math.random() > 0.5 ? 'steal' : 'stay' };
    }

    function evaluateCondition(condition, round, opponentHistory) {
      const parts = condition.split(' ');
      const operator = parts[0];
      const value = parts.slice(1).join(' ');

      if (operator === 'round') return parseInt(value) === round;
      if (operator === 'not') {
        if (value === 'round 1') return round !== 1;
      }
      throw new Error(`Invalid condition: "${condition}"`);
    }

    function executeAction(action, opponentHistory, round) {
      if (['steal', 'stay'].includes(action.toLowerCase())) return action.toLowerCase();
      return action; // Fallback to original behavior
    }

    function showConsole(message) {
      const consoleDiv = document.getElementById('console');
      const consoleContent = document.getElementById('console-content');
      consoleDiv.style.display = 'block';
      consoleContent.textContent = message;
    }

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.backgroundColor = type === 'error' ? '#dc3545' : type === 'info' ? '#17a2b8' : '#28a745';
      notification.style.display = 'block';
      setTimeout(() => notification.style.display = 'none', 3000);
    }

    function applyExample(example) {
      const codeMap = {
        'steal': 'steal',
        'stay': 'stay',
        'random': 'if round 1 then steal else stay',
        'firstSteal': 'if round 1 then steal else stay',
        'stayFirst': 'if round 1 then stay else steal',
        'evenSteal': 'if round 2 then steal else stay',
        'oddStay': 'if round 1 then stay else steal',
        'stealIfEarly': 'if round 5 then steal else stay'
      };
      document.querySelector('#code-area').value = codeMap[example] || '';
      updateLineNumbers();
      validateCode();
    }

    function showWhatIsThis() {
      alert(
        'Welcome to the Bot Editor!\n\n' +
        '- Create/edit bots with unique strategies.\n' +
        '- Enter a Username/Bot Name to identify your bot.\n' +
        '- Use commands like `steal`, `stay`, `if`, or `random(0-100)`.\n' +
        '- Test your bot and save to compete!\n' +
        '- Delete bots from "My Bots" page.'
      );
    }

    function showCommands() {
      alert(
        'Available Commands:\n' +
        '- `steal`: Always steal.\n' +
        '- `stay`: Always stay.\n' +
        '- `if round N then action else action`: Choose based on round number.\n' +
        'Example: `if round 1 then steal else stay`'
      );
    }

    function validateCode() {
      const code = document.getElementById('code-area').value;
      const errors = [];
      const lines = code.split('\n');
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line && !line.startsWith('//')) {
          if (!line.match(/^(steal|stay|if round \d+ then (steal|stay)( else (steal|stay))?)$/i)) {
            errors.push(`Line ${i + 1}: Invalid syntax`);
          }
        }
      }
      if (errors.length) showConsole(errors.join('\n'));
      else document.getElementById('console').style.display = 'none';
    }

    // Auto-save every 10 seconds
    function autoSave() {
      if (editMode && currentBotId) {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(saveBot, 10000);
      }
    }
    document.getElementById('code-area').addEventListener('input', autoSave);

    fetchBot();
    updateLineNumbers();
    validateCode();

    // Debug: Log when the page loads
    console.log('create-edit-bot.html loaded successfully at:', window.location.href);
  </script>
</body>
</html>
