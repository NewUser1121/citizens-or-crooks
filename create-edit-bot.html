<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create/Edit Bot - Kaleb's Citizens or Crooks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #1e3c72;
      font-family: 'Arial', sans-serif;
      color: #d4d4d4;
    }
    .container {
      padding: 40px;
      text-align: center;
    }
    .bot-section {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #2a5298;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    .btn {
      border-radius: 20px;
      padding: 12px 25px;
      margin: 5px;
      background-color: #3a6bb8;
      border: none;
      color: #d4d4d4;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
    }
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      background-color: #4d7cce;
    }
    select {
      width: 100%;
      padding: 5px;
      border-radius: 10px;
      background-color: #1e3c72;
      color: #d4d4d4;
      border: 1px solid #3a6bb8;
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      border-radius: 10px;
      background-color: #1e3c72;
      color: #d4d4d4;
      border: 1px solid #3a6bb8;
      resize: vertical;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: #fff;
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 1000;
      animation: fadeInOut 3s ease;
    }
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; transform: translateY(-20px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .notification { top: 10px; right: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="bot-section">
      <h2>Create/Edit Bot</h2>
      <div class="form-group">
        <label for="username">Username:</label>
        <input type="text" id="username" class="form-control" placeholder="Enter username">
      </div>
      <div class="form-group">
        <label for="bot-select">Select a Bot:</label>
        <select id="bot-select" class="form-control" onchange="loadBot()">
          <option value="">Choose a bot...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="bot-name">Bot Name:</label>
        <input type="text" id="bot-name" class="form-control" placeholder="Enter bot name">
      </div>
      <div class="form-group">
        <label for="bot-code">Bot Code:</label>
        <textarea id="bot-code" class="form-control" placeholder="Enter bot code (e.g., 'steal' or 'stay')"></textarea>
      </div>
      <button class="btn" onclick="saveBot()">Save</button>
      <button class="btn" onclick="done()">Done</button>
      <button class="btn" onclick="openFile()">Open</button>
      <button class="btn" onclick="testBot()">Test</button>
      <div id="examples" class="dropdown">
        <button class="btn dropdown-toggle" type="button" id="examples-btn" data-bs-toggle="dropdown" aria-expanded="false">Examples</button>
        <ul class="dropdown-menu" aria-labelledby="examples-btn">
          <li><a class="dropdown-item" href="#" onclick="loadExample('steal')">Always Steal</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('stay')">Always Stay</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('random')">Random Choice</a></li>
        </ul>
      </div>
      <button class="btn" onclick="deleteBot()">Delete</button>
      <button class="btn" onclick="whatIsThis()">What Is This</button>
      <div id="notification" class="notification"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentBotId = null;

    async function populateBots() {
      const username = document.getElementById('username').value.trim();
      if (!username) {
        showNotification('Please enter a username.', 'error');
        return;
      }
      try {
        const response = await fetch(`/api/bots?username=${encodeURIComponent(username)}`);
        const bots = await response.json();
        console.log('Fetched bots in create-edit:', bots);
        const botSelect = document.getElementById('bot-select');
        botSelect.innerHTML = '<option value="">Choose a bot...</option>';
        bots.forEach(bot => {
          const botName = bot.botname !== undefined ? bot.botname : 'Unnamed Bot';
          console.log(`Bot ${bot.id} name for display:`, botName);
          const option = document.createElement('option');
          option.value = bot.id;
          option.textContent = `${botName}`;
          botSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error fetching bots:', error);
        showNotification('Failed to load bots. Check console.', 'error');
      }
    }

    async function loadBot() {
      const botSelect = document.getElementById('bot-select');
      currentBotId = botSelect.value;
      if (!currentBotId) return;

      try {
        const response = await fetch(`/api/bots/${currentBotId}`);
        const bot = await response.json();
        console.log('Loaded bot:', bot);
        document.getElementById('bot-name').value = bot.botname || '';
        document.getElementById('bot-code').value = bot.code || '';
      } catch (error) {
        console.error('Error loading bot:', error);
        showNotification('Failed to load bot. Check console.', 'error');
      }
    }

    async function saveBot() {
      const username = document.getElementById('username').value.trim();
      const botName = document.getElementById('bot-name').value.trim();
      const botCode = document.getElementById('bot-code').value.trim();
      if (!username || !botName) {
        showNotification('Username and bot name are required.', 'error');
        return;
      }

      const botData = { botName, username, code: botCode };
      try {
        const url = currentBotId ? `/api/bots/${currentBotId}` : '/api/bots';
        const method = currentBotId ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(botData)
        });
        const result = await response.json();
        console.log('Save result:', result);
        if (response.ok) {
          showNotification('Bot saved successfully!', 'success');
          currentBotId = result.id || currentBotId;
          populateBots();
        } else {
          showNotification(`Failed to save bot: ${result.error}`, 'error');
        }
      } catch (error) {
        console.error('Error saving bot:', error);
        showNotification('Failed to save bot. Check console.', 'error');
      }
    }

    function done() {
      window.location.href = '/index.html';
    }

    function openFile() {
      showNotification('Open functionality not implemented yet.', 'info');
    }

    function testBot() {
      showNotification('Test functionality not implemented yet.', 'info');
    }

    function deleteBot() {
      if (!currentBotId) {
        showNotification('Please select a bot to delete.', 'error');
        return;
      }
      if (confirm('Are you sure you want to delete this bot?')) {
        fetch(`/api/bots/${currentBotId}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(result => {
            console.log('Delete result:', result);
            showNotification('Bot deleted successfully!', 'success');
            currentBotId = null;
            document.getElementById('bot-name').value = '';
            document.getElementById('bot-code').value = '';
            populateBots();
          })
          .catch(error => {
            console.error('Error deleting bot:', error);
            showNotification('Failed to delete bot. Check console.', 'error');
          });
      }
    }

    function whatIsThis() {
      showCommands();
    }

    function loadExample(example) {
      switch (example) {
        case 'steal':
          document.getElementById('bot-code').value = 'steal';
          break;
        case 'stay':
          document.getElementById('bot-code').value = 'stay';
          break;
        case 'random':
          document.getElementById('bot-code').value = '50% to steal';
          break;
        case 'firstRoundSteal':
          document.getElementById('bot-code').value = 'if round_number 1 then steal else stay';
          break;
        case 'copyOpponent':
          document.getElementById('bot-code').value = 'if opponent_last_steal then steal else stay';
          break;
        case 'stealIfOpponentStealsOften':
          document.getElementById('bot-code').value = 'if opponent_steal_count 5 then steal else 30% to steal';
          break;
      }
      showNotification('Example loaded!', 'success');
    }

    function showCommands() {
      alert(
        'Available Commands:\n' +
        '- `steal`: Always steal.\n' +
        '- `stay`: Always stay.\n' +
        '- `X% to steal/stay`: Random choice with X% probability (e.g., 50% to steal).\n' +
        '- `if condition then action [else action]`: Make a choice based on a condition.\n' +
        '- Conditions: `round_number N` (e.g., round_number 1 for round 1), `not round_number N` (e.g., not round_number 1 for not round 1),\n' +
        '  `opponent_last_steal` (if opponent stole last time), `not opponent_last_steal` (if opponent didnâ€™t steal last time),\n' +
        '  `opponent_steal_count N` (e.g., opponent_steal_count 5 if opponent stole 5+ times), `random 0-100` (random number 0-100).\n' +
        '- Actions: `steal`, `stay`, or `X% to steal/stay`.\n' +
        'Examples:\n' +
        '1. `steal` - Always steal every round.\n' +
        '2. `stay` - Always stay every round.\n' +
        '3. `50% to steal` - 50% chance to steal, 50% to stay.\n' +
        '4. `if round_number 1 then steal else stay` - Steal on round 1, then stay.\n' +
        '5. `if opponent_last_steal then steal else stay` - Copy what opponent did last time.\n' +
        '6. `if opponent_steal_count 5 then steal else 30% to steal` - Steal if opponent stole 5+ times, otherwise 30% chance to steal.'
      );
    }

    function validateCode() {
      const code = document.getElementById('bot-code').value;
      const errors = [];
      const lines = code.split('\n');
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line && !line.startsWith('//')) {
          if (!line.match(/^(steal|stay|\d+% to (steal|stay)|if (round_number \d+|not round_number \d+|opponent_last_steal|not opponent_last_steal|opponent_steal_count \d+|random 0-100) then (steal|stay|\d+% to (steal|stay))( else (steal|stay|\d+% to (steal|stay)))?)$/i)) {
            errors.push(`Line ${i + 1}: Invalid syntax`);
          }
        }
      }
      if (errors.length) showNotification(errors.join('\n'), 'error');
      else document.getElementById('notification').style.display = 'none';
    }

    // Auto-save every 10 seconds
    let autoSaveTimeout;
    function autoSave() {
      if (currentBotId) {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(saveBot, 10000);
      }
    }

    // Event listeners
    document.getElementById('username').addEventListener('input', populateBots);
    document.getElementById('bot-code').addEventListener('input', () => { validateCode(); autoSave(); });
    populateBots(); // Initial population
  </script>
</body>
</html>
