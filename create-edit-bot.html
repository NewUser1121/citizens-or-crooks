<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create/Edit Bot - Kaleb's Citizens or Crooks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #1e3c72; /* Original dark blue background */
      font-family: 'Arial', sans-serif;
      color: #d4d4d4; /* Light text for contrast */
    }
    .container {
      padding: 40px;
      text-align: center;
    }
    .bot-section {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #2a5298; /* Original section background */
      border: 2px solid #3a6bb8; /* Original border */
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    .btn {
      border-radius: 20px;
      padding: 12px 25px;
      margin: 5px;
      background-color: #3a6bb8; /* Original button color */
      border: none;
      color: #d4d4d4;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
    }
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      background-color: #4d7cce; /* Original hover color */
    }
    select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      background-color: #1e3c72;
      color: #d4d4d4;
      border: 1px solid #3a6bb8;
      font-size: 16px;
    }
    input[type="text"] {
      width: 100%; /* Increased size */
      padding: 12px; /* Increased padding */
      border-radius: 10px;
      background-color: #1e3c72;
      color: #d4d4d4;
      border: 1px solid #3a6bb8;
      font-size: 18px; /* Larger text */
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      border-radius: 10px;
      background-color: #1e3c72;
      color: #d4d4d4;
      border: 1px solid #3a6bb8;
      resize: vertical;
      font-size: 16px;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: #fff;
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 1000;
      animation: fadeInOut 3s ease;
    }
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; transform: translateY(-20px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .notification { top: 10px; right: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="bot-section">
      <h2>Create/Edit Bot</h2>
      <div class="form-group">
        <label for="username">Username:</label>
        <input type="text" id="username" class="form-control" placeholder="Enter username">
      </div>
      <div class="form-group">
        <label for="bot-select">Select a Bot:</label>
        <select id="bot-select" class="form-control" onchange="loadBot()">
          <option value="">Choose a bot...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="bot-name">Bot Name:</label>
        <input type="text" id="bot-name" class="form-control" placeholder="Enter bot name">
      </div>
      <div class="form-group">
        <label for="bot-code">Bot Code:</label>
        <textarea id="bot-code" class="form-control" placeholder="Enter bot code (e.g., 'steal' or 'stay')"></textarea>
      </div>
      <button class="btn" onclick="saveBot()">Save</button>
      <button class="btn" onclick="done()">Done</button>
      <button class="btn" onclick="openFile()">Open</button>
      <button class="btn" onclick="testBot()">Test</button>
      <div id="examples" class="dropdown">
        <button class="btn dropdown-toggle" type="button" id="examples-btn" data-bs-toggle="dropdown" aria-expanded="false">Examples</button>
        <ul class="dropdown-menu" aria-labelledby="examples-btn">
          <li><a class="dropdown-item" href="#" onclick="loadExample('steal')">Always Steal</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('stay')">Always Stay</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('random')">Random Choice</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('titForTat')">Tit for Tat</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('grimTrigger')">Grim Trigger</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('alternate')">Alternate Strategy</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('copyLast')">Copy Last Move</a></li>
          <li><a class="dropdown-item" href="#" onclick="loadExample('cooperateFirst')">Cooperate First</a></li>
        </ul>
      </div>
      <button class="btn" onclick="deleteBot()">Delete</button>
      <button class="btn" onclick="whatIsThis()">What Is This</button>
      <div id="notification" class="notification"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentBotId = null;

    async function populateBots() {
      const username = document.getElementById('username').value.trim();
      if (!username) {
        showNotification('Please enter a username.', 'error');
        return;
      }
      try {
        const response = await fetch(`/api/bots?username=${encodeURIComponent(username)}`);
        const bots = await response.json();
        console.log('Fetched bots in create-edit:', bots);
        const botSelect = document.getElementById('bot-select');
        botSelect.innerHTML = '<option value="">Choose a bot...</option>';
        bots.forEach(bot => {
          const botName = bot.botname !== undefined ? bot.botname : 'Unnamed Bot'; // Use lowercase botname
          console.log(`Bot ${bot.id} name for display:`, botName); // Debug
          const option = document.createElement('option');
          option.value = bot.id;
          option.textContent = `${botName}`;
          botSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error fetching bots:', error);
        showNotification('Failed to load bots. Check console.', 'error');
      }
    }

    async function loadBot() {
      const botSelect = document.getElementById('bot-select');
      currentBotId = botSelect.value;
      if (!currentBotId) return;

      try {
        const response = await fetch(`/api/bots/${currentBotId}`);
        const bot = await response.json();
        console.log('Loaded bot:', bot);
        document.getElementById('bot-name').value = bot.botname || ''; // Use lowercase botname
        document.getElementById('bot-code').value = bot.code || '';
      } catch (error) {
        console.error('Error loading bot:', error);
        showNotification('Failed to load bot. Check console.', 'error');
      }
    }

    async function saveBot() {
      const username = document.getElementById('username').value.trim();
      const botName = document.getElementById('bot-name').value.trim();
      const botCode = document.getElementById('bot-code').value.trim();
      if (!username || !botName) {
        showNotification('Username and bot name are required.', 'error');
        return;
      }

      const botData = { botName, username, code: botCode };
      try {
        const url = currentBotId ? `/api/bots/${currentBotId}` : '/api/bots';
        const method = currentBotId ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(botData)
        });
        const result = await response.json();
        console.log('Save result:', result);
        if (response.ok) {
          showNotification('Bot saved successfully!', 'success');
          currentBotId = result.id || currentBotId;
          populateBots();
        } else {
          showNotification(`Failed to save bot: ${result.error}`, 'error');
        }
      } catch (error) {
        console.error('Error saving bot:', error);
        showNotification('Failed to save bot. Check console.', 'error');
      }
    }

    function done() {
      window.location.href = '/index.html';
    }

    function openFile() {
      // Placeholder for file open functionality
      showNotification('Open functionality not implemented yet.', 'info');
    }

    function testBot() {
      // Placeholder for test functionality
      showNotification('Test functionality not implemented yet.', 'info');
    }

    function deleteBot() {
      if (!currentBotId) {
        showNotification('Please select a bot to delete.', 'error');
        return;
      }
      if (confirm('Are you sure you want to delete this bot?')) {
        fetch(`/api/bots/${currentBotId}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(result => {
            console.log('Delete result:', result);
            showNotification('Bot deleted successfully!', 'success');
            currentBotId = null;
            document.getElementById('bot-name').value = '';
            document.getElementById('bot-code').value = '';
            populateBots();
          })
          .catch(error => {
            console.error('Error deleting bot:', error);
            showNotification('Failed to delete bot. Check console.', 'error');
          });
      }
    }

    function whatIsThis() {
      showNotification('This is a bot creation and editing interface for Citizens or Crooks.', 'info');
    }

    function loadExample(example) {
      switch (example) {
        case 'steal':
          document.getElementById('bot-code').value = 'steal';
          showNotification('Example: Always Steal - This bot always chooses to steal, maximizing points if the opponent stays.', 'success');
          break;
        case 'stay':
          document.getElementById('bot-code').value = 'stay';
          showNotification('Example: Always Stay - This bot always chooses to stay, ensuring mutual benefit if the opponent also stays.', 'success');
          break;
        case 'random':
          document.getElementById('bot-code').value = '// Random choice example\nif (Math.random() > 0.5) { steal } else { stay }';
          showNotification('Example: Random Choice - This bot randomly selects steal or stay each round, introducing unpredictability.', 'success');
          break;
        case 'titForTat':
          document.getElementById('bot-code').value = '// Tit for Tat example\nif (opponentHistory.length > 0) { opponentHistory[opponentHistory.length - 1] } else { stay }';
          showNotification('Example: Tit for Tat - This bot starts by staying and then mimics the opponent\'s last move, encouraging cooperation.', 'success');
          break;
        case 'grimTrigger':
          document.getElementById('bot-code').value = '// Grim Trigger example\nif (opponentHistory.includes(\'steal\')) { steal } else { stay }';
          showNotification('Example: Grim Trigger - This bot stays until the opponent steals, then always steals thereafter as punishment.', 'success');
          break;
        case 'alternate':
          document.getElementById('bot-code').value = '// Alternate Strategy example\nif (round % 2 === 1) { steal } else { stay }';
          showNotification('Example: Alternate Strategy - This bot alternates between steal and stay each round, creating a predictable pattern.', 'success');
          break;
        case 'copyLast':
          document.getElementById('bot-code').value = '// Copy Last Move example\nif (opponentHistory.length > 0) { opponentHistory[opponentHistory.length - 1] } else { steal }';
          showNotification('Example: Copy Last Move - This bot starts by stealing and then copies the opponent\'s previous move.', 'success');
          break;
        case 'cooperateFirst':
          document.getElementById('bot-code').value = '// Cooperate First example\nif (round === 1) { stay } else { steal }';
          showNotification('Example: Cooperate First - This bot stays on the first round to encourage cooperation, then steals afterward.', 'success');
          break;
      }
    }

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.backgroundColor = type === 'error' ? '#dc3545' : '#28a745';
      notification.style.display = 'block';
      setTimeout(() => notification.style.display = 'none', 3000);
    }

    // Event listeners
    document.getElementById('username').addEventListener('input', populateBots);
    populateBots(); // Initial population
  </script>
</body>
</html>
